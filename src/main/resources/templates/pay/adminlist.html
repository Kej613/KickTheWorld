<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>admin page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ICON -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css">
  <!-- ADMIN CSS -->
  <link rel="stylesheet" th:href="@{/css/admin.css}">
  <!--HEADER, FOOTER CSS-->
  <!-- <link rel="stylesheet" href="headerFooter.css">  -->
  <script src="https://tbezauth.settlebank.co.kr/js/SettlePay.js"></script>
  <script src="/js/jquery-3.7.1.min.js"></script>

  <style>
    table {
      font-family: 'Pretendard-Regular';
      padding:7px;
      margin:7px;
      margin-left:auto;
      margin-right:auto;
      color:black;
      background-color: #FFFFFF;
    }
    h1 {
      font-family: 'Pretendard-Regular';
    }
    /*td,th{*/
    /*  padding:7px;*/
    /*}*/
  </style>
</head>
<body>

<!--- SIDE BAR -->
<div class="side-bar" style=" width: 16vw;">
  <div class="logo-name">
    <h2 style="color: white"> 안녕하세요, 관리자님! </h2>
  </div>
  <ul>
    <li><i class="ri-dashboard-line" style="font-size: 1.5rem;"></i><a th:href="@{/admin}"> &nbsp 대시보드</a></li>
    <li><i class="ri-money-dollar-circle-line" style="font-size: 1.5rem;"></i><a th:href="@{/adminlist}"> &nbsp 예약/결제</a></li>
    <li><i class="ri-funds-box-line" style="font-size: 1.5rem;"></i><a th:href="@{/admin/statistics}"> &nbsp 통계</a></li>
    <li><i class="ri-settings-4-line" style="font-size: 1.5rem;"></i><a th:href="@{/notready}"> &nbsp 설정</a></li>
  </ul>
</div>

<!-- HEADER -->
<div class="container">
  <div class="header" >
    <div class="nav">
      <ul>
        <li>
          <a th:href="@{/board/list}"><b>여행게시판</b></a>
        </li>
        <li>
          <a th:href="@{/admin}"><b>관리자페이지</b></a>
        </li>
        <li>
          <a th:href="@{/members/login}"
             th:if="${#authorization.expression('isAnonymous()')}"><b>로그인</b></a>
        </li>
        <li>
          <a th:href="@{/members/new}"
             th:if="${#authorization.expression('isAnonymous()')}"><b>회원가입</b></a>
        </li>
        <li>
          <a th:href="@{/members/logout}"
             th:if="${#authorization.expression('isAuthenticated()')}"><b>로그아웃</b></a>
        </li>
      </ul>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="pay_content">
    <div>
      <form method="post" action="" id="payForm" name="payForm" >
        <div style="margin-top: 100px;">
          <h2 style="text-align:center;">전체결제내역</h2><br>
          <!-- container -->
          <div class="container" style="margin-left:auto; margin-right:auto;">
            <div class="table-responsive" style="margin-left:auto; margin-right:auto; text-align:center">
              <table class="table" style="width:100%; text-align:center;">
                <thead>
                <tr>
                  <th>ID</th>
                  <th>숙소명</th>
                  <th>회원아이디</th>
                  <th>숙소번호</th>

                  <!--                            <th>승인번호</th>-->
                  <th>거래번호</th>
                  <th>숙소금액</th>
                  <th>결제상태</th>
                  <th>기타</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="pay : ${payList}" style="height: 30px;">
                  <td th:text="${pay.id}"></td>
                  <td th:text="${pay.productNm}" style="width:40%;"></td>
                  <td th:text="${pay.ordNo.substring(pay.ordNo.lastIndexOf('_') + 1)}"></td>
                  <td th:text="${pay.ordNo}"></td>
                  <!--                                <td th:text="${pay.authNo}"></td>-->
                  <td th:text="${pay.trNo}"></td>
                  <td th:text="${#strings.replace(#numbers.formatDecimal(pay.trPrice, 0, 'COMMA', 2, 'POINT'), '.00', '')+'원'}" style="width:40%;"></td>
                  <th:block th:switch="${pay.payStatus}">
                    <td th:case="${'P'}">결제완료</td>
                    <td th:case="${'C'}">결제취소완료</td>
                  </th:block>
                  <td th:if="${pay.payStatus == 'P'}">
                    <button type="button" th:onclick="goCancel([[${pay.ordNo}]], [[${pay.trNo}]])">결제취소</button>
                  </td>
                  <td th:if="${pay.payStatus == 'C'}"></td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
          <!-- //container -->
        </div>
      </form>
    </div>

  </div>
</div>
<script th:inline="javascript">
  function goCancel(ordNo, trNo) {
    console.log(ordNo + ", " + trNo)
    $.ajax({
      type : 'POST',
      url : '/payCancel',
      dataType : 'JSON',
      data : {
        ordNo: ordNo,
        trNo: trNo
      },
      success: function(data) {
        if(data.resultCd == "0"){
          alert("결제 취소 성공");
          location.reload();
        }else{
          alert("결제 취소 실패 : " + data.resultMsg);
        }
      },
      error: function(e) {
        alert("처리중 오류가 발생했습니다");
      }
    });
  }
</script>
</body>
</html>